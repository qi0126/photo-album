<!DOCTYPE html>
<html>
<head>
   <title>产品库</title>
   <link rel="stylesheet" type="text/css" href="../css/bootstrap.min.css">
   <link href="../css/jBootsrapPage.css" rel="stylesheet" />
   <link rel="stylesheet" type="text/css" href="../css/products.css">
   <script src="../js/jquery.min.js"></script>
   <script src="../js/bootstrap.min.js"></script>
   <script src="../js/jBootstrapPage.js"></script>
   <script type="text/javascript" src="../js/http.js"></script>
</head>
<body style="background-color:#eee;">
	<div class="content">
		<p>珠宝图鉴后台>产品管理>产品库</p>
		<div class="control_panel">
			<select name="category" onchange="selectCategory(this)">
				<option value="0">全部大类</option>
			</select>
			<input type="text" name="search">
			<button id="btn_search" onclick="searchProduct(this)" class="btn btn-primary">搜索</button><br>
			<input type="checkbox" name="all_selected" onchange="allSelectOs(this)" style="margin-top:2em;">全选
			<button class="btn btn-primary">批量调整分类</button>
			<button class="btn btn-primary" onclick="multiOnOffLine(this)">批量上/下架</button>
			<button class="btn btn-primary" onclick="multiDel(this)">批量删除</button>
			<button class="btn btn-primary">更新产品库</button>
			<button onclick="addToCategory(this)" class="btn btn-primary">批量添加到推广类别</button>
			<table>
				<thead>
					<tr>
						<td>&nbsp;&nbsp;</td><td>匹配图</td><td>产品</td><td>产品编号</td>
						<td>更新时间<button>V</button></td>
						<td>
                            <select onchange="searchAboutOnOffLine(this)" width="50px" name="search_on_off_line">
                                <option value="*">当前状态</option>
                                <option value="1">已上架</option>
                                <option value="0">未上架</option>
                            </select>
						</td>
						<td>操作</td>
					</tr>
				</thead>
				<tbody></tbody>
			</table>
			<ul class="pagination"></ul>
		</div>
	</div>

	<div id="cover" class="cover"></div>
  <div id="oncover" class="oncover"></div>
</body>
</html>
<script type="text/javascript">
	function allSelectOs(elem){
		if($(elem).is(':checked')){
			$('tbody').find('input[type=checkbox]').prop('checked', true);
		}else{
			$('tbody').find('input[type=checkbox]').prop('checked', false);
		}
	}

	function multiDel(elem){
		var number = $(elem).parent().parent().attr('id');
		var selected_list = $('tbody').find('input[type=checkbox]');
		var list = [];
		selected_list.each(function(){
			if($(this).is(':checked')){
				list.push($(this).parent().parent().attr('id'));
			}
		});
		var post_data = new FormData();
		post_data.append("list", JSON.stringify(list));
		if(list.length > 0){
			if(confirm("确定要批量删除选择的产品?")){
				$(elem).attr('disabled', 'disabled');
				http.postAjax_clean("/photo-album/product/product_delete_with_list", post_data, function(data){
					if(data['state']==true){
						$(elem).removeAttr('disabled');
						alert('成功删除批量选择的产品');
						location.reload();
					}else{
						$(elem).removeAttr('disabled');
						alert('尚未批量删除选择的产品');
					}
				});
			}
		}else{
			alert('请选择要操作的产品');
		}
	}
	//产品下拉上下架状态的分类JS
	function searchAboutOnOffLine(elem){
		var isonline = $('select[name=search_on_off_line]').find('option:checked').val();
		http.getAjax_clean('/photo-album/product/get_all_product?type=0&size=5&page=1&isonline='+isonline, function(data){
			console.log(data);
			var total = data.totlesize;
			var data = data.page;
			createPage(5, 8, total);
			$('.pagination').find('li').eq(2).find('a').click();
		});
	}
	//批量上下架的JS
	function multiOnOffLine(elem){
		var number = $(elem).parent().parent().attr('id');
		var selected_list = $('tbody').find('input[type=checkbox]');
		var list = [];
		selected_list.each(function(){
			if($(this).is(':checked')){
				list.push($(this).parent().parent().attr('id'));
			}
		});
		//批量上/下架弹窗的JS
		var createAndInsertOnOffLineHtml = function(){
			var html = '';
			html += '<div style="width:50%; margin: 0 auto; margin-top:10%; border:1px solid #1E90FF; background-color:#ccc; font-weight:bold;">'
			html += '  <div style="background-color:#1E90FF; padding:.75em 0; font-size:1.25em; color:white;">批量上/下架</div>'
			html += '  <div id="radio" style="background-color: #eee; padding: 2em 0; text-align: center;">';
			html += '    <input name="onoff" type="radio" value="on" checked/>上架&nbsp;&nbsp;<input  name="onoff" type="radio" value="off" />下架';
			html += '  </div>';
			html += '  <div style="float:right;"><button onclick="updateOnOffLine(this)">确定</button><button onclick="closeCover(this)">取消</button></div>';
			html += '  <div style="clear:both;"></div>';
			html += '</div>';
			$('#oncover').html(html);
		};
		if(list.length>0){
			createAndInsertOnOffLineHtml();
			showCover();
		}else{
			alert('请选择要操作的产品');
		}
	}
	//更新上下架确认按钮JS
	function updateOnOffLine(elem){
		var op = null;
		$('#oncover').find('input[type=radio]').each(function(){
			if($(this).is(':checked')){
				op = $(this).val();
			}
		});
		var isonline = (op=='on') ? true : false;
		var list = [];
		var selected_list = $('tbody').find('input[type=checkbox]');
		var op_list = [];
		selected_list.each(function(){
			if($(this).is(':checked')){
				op_list.push($(this).parent().parent());
				list.push($(this).parent().parent().attr('id'));
			}
		});
		var post_data = new FormData();
		post_data.append('list', JSON.stringify(list));
		post_data.append('isonline', isonline);
		http.postAjax_clean("/photo-album/product/set_offline_and_online_with_list", post_data, function(data){
			closeCover();
			if(isonline){
				for(var i=0;i<op_list.length;i++){
					op_list[i].find('td:last').find('button:first').replaceWith('<button onclick="toOffLine(this)" class="btn btn-warning">下架</button>');
					op_list[i].find('td').eq(5).html('已上架');
				}
				if($('input[name=all_selected]').is(':checked')){
					$('input[name=all_selected]').prop('checked', false);
				}
				$('tbody').find('input[type=checkbox]').prop('checked', false);
			}else{
				for(var i=0;i<op_list.length;i++){
					op_list[i].find('td:last').find('button:first').replaceWith('<button onclick="toOnLine(this)" class="btn btn-primary">上架</button>');
					op_list[i].find('td').eq(5).html('未上架');
				}
				if($('input[name=all_selected]').is(':checked')){
					$('input[name=all_selected]').prop('checked', false);
				}
				$('tbody').find('input[type=checkbox]').prop('checked', false);
			}
		});
	}
	//更新上/下架JS
	function updateCategory(elem){
		var to_category_list = $('#oncover').find('input:checked');
		var will_update_category_products = $('tbody').find('input:checked');
		var post_data = new FormData();
		var obj = {
			"linkids": [],
			"products": []
		};
		to_category_list.each(function(){
			obj.linkids.push($(this).attr('id'));
		});
		will_update_category_products.each(function(){
			obj.products.push($(this).parent().parent().attr('id'));
		});
		var jsonObj = JSON.stringify(obj);
		post_data.append('param', jsonObj);
		http.postAjax_clean("/photo-album/product/save_toic", post_data, function(data){
			if(data['state']==true){
				alert('添加到推广类别成功.');
				location.reload();
			}else{
				alert('添加到推广类别失败!');
			}
		});
	}
	//批量添加推广类别JS
	function addToCategory(elem){
		var will_update_category_products = $('tbody').find('input:checked');
		if(will_update_category_products.length>0){
			http.getAjax_clean("/photo-album/manger/get_products", function(data){
				showCover(elem);
				var classList = [];
				for(var i=0;i<data.length;i++){
					for(var j=0;j<data[i].products.length;j++){
						classList.push(data[i].products[j]);
					}
				}
				var createAndInsertCategoryHtml = function(data_list){
					var html = '<div style="width:50%; margin: 0 auto; margin-top:10%; border:1px solid #1E90FF; background-color:#ccc; font-weight:bold;">';
					html += '  <div style="background-color:#1E90FF; padding:.75em 0; font-size:1.25em; color:white;">添加到推广类别</div>'
					html += '  <div style="background-color: #eee; padding: 2em 0; text-align: center;">';
					for(var k=0;k<data_list.length;k++){
						html += '  <input type="checkbox" id="'+data_list[k].productId+'"/>'+data_list[k].name;
					}
					html += '  </div>';
					html += '  <div style="float:right;"><button onclick="updateCategory(this)">确定</button><button onclick="closeCover(this)">取消</button></div>';
					html += '  <div style="clear:both;"></div>';
					html += '</div>';
					$('#oncover').html(html);
				};
				createAndInsertCategoryHtml(classList);
			});
		}else{
			alert('请选择要操作的产品');
		}
	}
	//选择分类
	function selectCategory(elem){
		var selectValue = $(elem).find('option:selected').val();
		model.type = selectValue;
		http.getAjax_clean('/photo-album/product/get_all_product?isonline=*&size=5&page=1'+'&type='+model.type, function(data){
			var total = data.totlesize;
			var data = data.page;
			createPage(5, 8, total);
			$('.pagination').find('li').eq(2).find('a').click();
		});
	}

	function searchProduct(elem){
		var keyWord = $('input[name=search]').val();
		keyWord = keyWord || null;
		if(keyWord==null||keyWord==undefined||keyWord.length>20){
			return;
		}
		http.getAjax_clean('/photo-album/product/product_search?key='+keyWord, function(data){
			$('.pagination').jBootstrapPage({
				pageSize: 10,
				maxPageButton: 8,
				total: data.totlesize,
				onPageClicked: function(obj, pageIndex){
					createHtmlInsertTbody(data.page);
				}
			});
			setTimeout(function(){
				$('.pagination').find('li').eq(2).find('a').click();
			}, 300);
		});
	};
	//“上架”按钮JS
	function toOnLine(elem){
		var number = $(elem).parent().parent().attr('id');
		var isonline = true;
		var post_data = new FormData();
		post_data.append('number', number);
		post_data.append('isonline', isonline);
		http.postAjax_clean('/photo-album/product/set_offline_and_online', post_data, function(data){
			if(data['state']==true){
				$(elem).parent().prev().text('已上架');
				$(elem).replaceWith('<button onclick="toOffLine(this)" class="btn btn-warning">下架</button>');
			}else{
				alert('设置产品上线异常.');
			}
		});
	}
	//“下架”按钮JS
	function toOffLine(elem){
		var number = $(elem).parent().parent().attr('id');
		var isonline = false;
		var post_data = new FormData();
		post_data.append('number', number);
		post_data.append('isonline', isonline);
		http.postAjax_clean('/photo-album/product/set_offline_and_online', post_data, function(data){
			if(data['state']==true){
				$(elem).parent().prev().text('未上架');
				$(elem).replaceWith('<button onclick="toOnLine(this)" class="btn btn-primary">上架</button>');
			}else{
				alert('设置产品下线异常.');
			}
		});
	}
	//编辑按钮JS
	function toEdit(elem){
		//console.log(elem);
		var index = $(elem).attr('data-index');
		var jsonObj = localStorage.getItem('edit_products');
		var will_edit_product_list = JSON.parse(jsonObj);
		localStorage.setItem('current_edit_product', JSON.stringify(will_edit_product_list[index]));
		location.href = '/photo-album/web/edit_product.html';
	}
	//删除按钮JS
	function toDel(elem){}
	//创建Html插入tbody
	function createHtmlInsertTbody(data){
		//console.log(data);
		localStorage.setItem('edit_products', JSON.stringify(data));
		var html = '';
		for(var i=0; i<data.length; i++){
			html += '<tr id="'+data[i].number+'">\
								<td><input type="checkbox" name="select"></td>\
								<td><img src="../image/'+data[i].image+'" width="120px"></td>\
								<td>产品名称:<span>'+decodeURIComponent(data[i].name)+'</span><br>产品分类:<span>'+data[i].category+'</span></td>\
								<td>'+data[i].number+'</td>\
								<td>2016-08-26 19:20</td>\
								<td>'+(data[i].online ? '已上架': '未上架')+'</td>\
								<td>'+(data[i].online ? '<button onclick="toOffLine(this)" class="btn btn-warning">下架</button>' : '<button onclick="toOnLine(this)" class="btn btn-primary">上架</button>')+'<button data-index="'+i+'" onclick="toEdit(this)" class="btn btn-success">编辑</button><button onclick="toDel(this)" class="btn btn-danger">删除</button></td>\
							</tr>';
		}
		$('tbody').html(html);
	}
	//创建分页按钮
	function createPage(pageSize, buttons, total) {
		$(".pagination").jBootstrapPage({
			pageSize : pageSize,
			maxPageButton: buttons,
			total : total,
			onPageClicked: function(obj, pageIndex) {
				/*console.log(pageIndex+1); //起始页面为0,需+1*/
				http.getAjax_clean('/photo-album/product/get_all_product?isonline=*&size='+pageSize+'&page='+(pageIndex+1)+'&type='+model.type, function(data){
					createHtmlInsertTbody(data.page);
				});
			}
		});
	}
	//显示内容
	var showCover = function(elem) {
    $('body').css('overflow', 'hidden');
    $('#cover').show();
    $('#oncover').show();
	};
	//关闭内容
	var closeCover = function(elem) {
    $('body').css('overflow', 'visible');
    $('#cover').hide();
    $('#oncover').hide();
	};
	//分页内容JS
	$(function(){
		model = {type: 0};
		http.getAjax_clean('/photo-album/product/getcategory', function(data){
			//alert("aaa");
			console.log(data);
			for(var i=0;i<data.length;i++){
				$('select[name=category]').append('<option value="'+(i+1)+'">'+data[i]+'</option>');
			}
		});
		var pageSize = 5;
		var maxPageButton = 8;
		http.getAjax_clean('/photo-album/product/get_all_product?type=0&size='+pageSize+'&page=1&isonline=*', function(data){
			var total = data.totlesize;
			var data = data.page;
			createPage(pageSize, maxPageButton, total);
			$('.pagination').find('li').eq(2).find('a').click();
		});
	});
</script>
